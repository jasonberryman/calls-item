<link rel="import" href="../paper-audio-player/paper-audio-player.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../iron-collapse/iron-collapse.html">
<link rel="import" href="../paper-item/paper-icon-item.html">
<link rel="import" href="../paper-item/paper-item-body.html">
<link rel="import" href="../date-display/date-display.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../polymer/polymer.html">
<!--
  `<calls-item></calls-item>` demo
  @demo demo.html
-->
<link rel="import" href="leg-item.html">
<dom-module id="calls-item">
  <template>
    <style>
      :host {
        font-family: 'Roboto', 'Noto', sans-serif;
        -webkit-font-smoothing: antialiased;
        font-size: 14px;
        line-height: 20px;
        display:block;
        background:#fff;
      }
      div.footer {
        min-height:50px
      }
      .arrow {
        color: #99c75f;
        font-size: bigger;
      }
    </style>
    <paper-material elevation="[[elevation]]">
      <paper-icon-item elevation="1">
        <div item-icon>
          <template is="dom-if" if="[[!photo]]">
            <text-avatar name="[[displayName]]">[[displayName.0]]</text-avatar>
          </template>
          <template is="dom-if" if="[[photo]]">
            <img style="width:36px;margin:6px;border-radius:50%" src="[[photo]]" />
          </template>
        </div>
        <paper-item-body two-line>
          <span> [[from]] <strong class="arrow">&rArr;</strong> [[to]] </span>
          <template is="dom-if" if="[[description]]">
            <div secondary>[[description]]</div>      
          </template>
          <template is="dom-if" if="[[times]]">
            <div secondary>
              <date-display value="[[times.received]]" format="DD MMM"></date-display>
              <iron-icon icon="communication:call" style="color:green"></iron-icon>
              <date-display value="[[times.received]]" format="HH:mm"></date-display>
              <iron-icon icon="communication:call-end" style="color:red"></iron-icon>
              <date-display value="[[times.cleared]]" format="HH:mm"></date-display>
              <iron-icon icon="device:access-time" style="color:dark-gray"></iron-icon>
              [[times.duration]]
            </div>
          </template>
        </paper-item-body>
      </paper-icon-item>

      <iron-collapse id="collapse">
        <iron-selector attr-for-selected="id" selected="{{legSelected}}">
          <template is="dom-repeat" items="[[legs]]">
            <leg-item id="[[item.__key]]" index="[[index]]" state="[[item.state]]" from="[[item.source.displayName]]" to="[[item.target.displayName]]" on-tap="setAudio" audio="[[item.audio]]"></leg-item>
          </template>
        </iron-selector>
        <div class="footer">
          <template is="dom-repeat" items="[[elements]]">
            [[item.__key]]
            <date-display value="[[item.receivedLocal]]" format="HH:mm"></date-display>
          </template>
          <template is="dom-if" if="[[audio]]">
            <paper-audio-player src="[[audio.file]]" title="[[audio.title]]"></paper-audio-player>
          </template>
        </div>
      </iron-collapse>
    </paper-material>
  </template>
</dom-module>
<script>
  Polymer({
    is: "calls-item",
    properties: {
      items: {
        type:Array,
        value:[],
      },
      elevation: {
        value:"1"
      },
      legs: {
        type: Array,
      },
      elements: {
        type: Array,
      },
      _element:{
        computed: "getElements(legsRef,legSelected)"
      },
      opened: {
        computed: "setOpened(id, callSelected)"
      },
      times: {
        type: Object,
        observer: '_log', 
      },
      callSelected: String,
    },
    _log: function(a,b,c) {
      console.log(a,b,c)
    },
    getElements: function(legsRef,legSelected){
      var that = this
      if (this.unsubscribeElements) {
        this.unsubscribeElements()
      }
      this.elements = []
      this.elementsRef = legsRef.doc(legSelected).collection("elements")
      
      this.unsubscribeElements = this.elementsRef.where('receivedUTC', '>', 0).onSnapshot(function(doc) {
        if (doc) {
          var elements = []
          for (var index in doc.docs) {
            var data = doc.docs[index].data()
            data.__key = doc.docs[index].id
            elements.push(data)
          }
          that.elements = elements
        } else {
          console.log("No such collection!")
        }
      }, function(error) {
        console.log(error)
      })
    },
    setOpened: function(id, callSelected){
      if (id == callSelected) {
        this.open()
      } else {
        this.close()
      }
    },
    close: function(){
      this.$$("iron-collapse").hide()
    },
    open: function(){
      this.$$("iron-collapse").show()
    },
    setAudio: function(e,d){
      this.audio = e.target.audio
    },
  })
</script>
